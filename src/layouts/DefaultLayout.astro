---
import { getCurrentLang } from "@/i18n/utils";
import "../styles/global.css";
import Head from "@/components/Head.astro";
import { themeInitScript } from "@/components/theme/theme-init";
import { getProfile } from "@/i18n/data/profile";
import { BackgroundHalos } from "../components/ui";

// Déduction automatique de la locale à partir de l'URL
const locale = getCurrentLang();

// Get the profile data for the title
const profile = await getProfile(locale);

// SEO optimized meta tags
const title = `${profile.name} - ${profile.title}`;
const description =
  profile.description ||
  `${profile.name}, ${profile.title} - Développeur full-stack expérimenté`;
const url = Astro.url.href;
const imageUrl = new URL("/avatar.png", Astro.url).href;

// Script pour l'Intersection Observer des animations chroma-text
const chromaAnimationScript = `
(function() {
  if (typeof window !== 'undefined' && 'IntersectionObserver' in window) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate');
          // Une fois animé, on arrête d'observer
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });

    // Observer tous les éléments avec la classe chroma-text-viewport
    document.addEventListener('DOMContentLoaded', () => {
      const elements = document.querySelectorAll('.chroma-text-viewport');
      elements.forEach(el => observer.observe(el));
    });
  }
})();
`;
---

<html lang={locale}>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      /></noscript
    >

    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="author" content={profile.name} />
    <meta name="robots" content="index, follow" />
    <meta name="language" content={locale} />
    <meta name="revisit-after" content="7 days" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={url} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={profile.name} />
    <meta property="og:locale" content={locale} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={imageUrl} />

    <!-- Canonical URL -->
    <link rel="canonical" href={url} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="apple-touch-icon" href="/favicon.png" />

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Preload critical assets -->
    <link rel="preload" href="/avatar.png" as="image" />

    <!-- DNS prefetch for external domains -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />

    <Head />
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-primary focus:text-primary-foreground focus:rounded-md"
    >
      Aller au contenu principal
    </a>

    <BackgroundHalos />
    <main id="main-content">
      <slot />
    </main>
    <script is:inline set:html={themeInitScript} />
    <script is:inline set:html={chromaAnimationScript} />

    <!-- Service Worker Registration -->
    <!-- <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    </script> -->
  </body>
</html>
